@page "/admin"
@using LoLProject.ApiService.DTOs
@using Microsoft.AspNetCore.Authorization
@using LoLProject.WebApp.Clients
@using LoLProject.WebApp.DTOs
@attribute [Authorize]
@inject LoLClient LoLClient
@inject IJSRuntime JS

<PageTitle>Administration Hextech</PageTitle>

@{
string iconCdn = "https://ddragon.leagueoflegends.com/cdn/14.23.1/img/profileicon/";
}



<div class="container mt-4 mb-5">

    <div class="admin-header d-flex justify-content-between align-items-center">
        <div>
            <h1 class="text-uppercase fw-bold" style="color: #c8aa6e; letter-spacing: 2px;">
                <i class="bi bi-shield-lock-fill"></i> Nexus Admin
            </h1>
            <p class="mb-0 text-gold opacity-75">Gestion des donn√©es, invocateurs et contenu.</p>
        </div>
        <span class="badge bg-warning text-dark border border-light shadow">Mode Super-Admin</span>
    </div>

    <div class="accordion accordion-hextech mb-5" id="adminAccordion">

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSystem">
                    <i class="bi bi-cpu-fill me-2"></i> Syst√®me & Donn√©es
                </button>
            </h2>
            <div id="collapseSystem" class="accordion-collapse collapse show" data-bs-parent="#adminAccordion">
                <div class="accordion-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card hextech-card h-100">
                                <div class="card-body text-center p-4">
                                    <div class="card-icon mb-3"><i class="bi bi-cloud-arrow-down-fill"></i></div>
                                    <h5 class="card-title text-uppercase text-gold">Synchronisation Riot</h5>
                                    <p class="card-text small text-light opacity-75">Mise √† jour DataDragon (Images, Stats, Lore).</p>
                                    <button class="btn btn-outline-warning w-100 mt-2" @onclick="SyncChampions" disabled="@isSyncing">
                                        @if (isSyncing) { <span class="spinner-border spinner-border-sm me-2"></span><span>Travail en cours...</span> }
                                        else { <span><i class="bi bi-arrow-repeat"></i> Lancer Synchro</span> }
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card hextech-card h-100">
                                <div class="card-body text-center p-4">
                                    <div class="card-icon mb-3 text-danger"><i class="bi bi-radioactive"></i></div>
                                    <h5 class="card-title text-uppercase text-danger">Purge Base de Donn√©es</h5>
                                    <p class="card-text small text-light opacity-75">Supprime tous les champions locaux.</p>
                                    <button class="btn btn-outline-danger w-100 mt-2" @onclick="ResetDb" disabled="@isPurging">
                                        @if (isPurging) { <span class="spinner-border spinner-border-sm"></span><span>Nettoyage...</span> }
                                        else { <span><i class="bi bi-trash-fill"></i> Tout Supprimer</span> }
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUsers">
                    <i class="bi bi-people-fill me-2"></i> Invocateurs (@(users?.Count ?? 0))
                </button>
            </h2>
            <div id="collapseUsers" class="accordion-collapse collapse" data-bs-parent="#adminAccordion">
                <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="hextech-table">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Utilisateur</th>
                                <th>Compte Li√©</th>
                                <th class="text-end">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            @if (users != null)
                            {
                            @foreach (var user in users)
                            {
                            <tr>
                                <td><span class="text-gold small">#@user.Id.ToString().Substring(0, 6)...</span></td>
                                <td class="fw-bold text-white">@user.Username</td>
                                <td>
                                    @if (user.Summoner != null)
                                    {
                                    <img src="@($"{iconCdn}{user.Summoner.ProfileIconId}.png")" class="summoner-mini-icon" alt="icon" />
                                    <span class="text-gold">@user.Summoner.GameName</span>
                                    <span class="text-muted small">#@user.Summoner.TagLine</span>
                                    }
                                    else { <span class="badge bg-secondary bg-opacity-25 border border-secondary text-secondary">Non li√©</span> }
                                </td>
                                <td class="text-end">
                                    @if (user.Summoner != null)
                                    {
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => RequestUnlinkUser(user)">
                                        <i class="bi bi-link-45deg"></i>
                                    </button>
                                    }
                                    else
                                    {
                                    <button class="btn btn-sm btn-outline-success" @onclick="() => OpenLinkModal(user)">
                                        <i class="bi bi-plug-fill"></i>
                                    </button>
                                    }
                                </td>
                            </tr>
                            }
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTips">
                    <i class="bi bi-chat-quote-fill me-2"></i> Conseils & Tips (@(tips?.Count ?? 0))
                </button>
            </h2>
            <div id="collapseTips" class="accordion-collapse collapse" data-bs-parent="#adminAccordion">
                <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="hextech-table">
                            <thead>
                            <tr>
                                <th>Champion</th>
                                <th>Auteur</th>
                                <th>Contenu</th>
                                <th>Date</th>
                                <th class="text-end">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            @if (tips != null)
                            {
                            @foreach (var tip in tips)
                            {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <img src="@tip.ChampionIconUrl" width="32" height="32" class="rounded-circle border border-secondary">
                                        <span class="text-gold">@tip.ChampionName</span>
                                    </div>
                                </td>
                                <td>@tip.AuthorName</td>
                                <td>
                                    @{ var preview = tip.Content.Length > 50 ? tip.Content.Substring(0, 50) + "..." : tip.Content; }
                                    <span class="text-light" title="@tip.Content">@preview</span>
                                </td>
                                <td class="small text-gold">@tip.CreatedAt.ToLocalTime().ToString("dd/MM HH:mm")</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => OpenEditTipModal(tip)">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => RequestDeleteTip(tip)">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </td>
                            </tr>
                            }
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-12">
            <h6 class="text-uppercase text-gold mb-2"><i class="bi bi-terminal-fill me-2"></i>Console</h6>
            <div class="console-output shadow-sm">
                @if (logs.Count == 0) { <span class="text-gold fst-italic">// En attente...</span> }
                @foreach (var log in Enumerable.Reverse(logs)) { <div class="log-entry"><span class="log-time">@log.Time</span> @log.Message</div> }
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="linkUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-hextech">
            <div class="modal-header">
                <h5 class="modal-title text-gold">Lier Compte</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control hextech-textarea mb-2" @bind="linkGameName" placeholder="GameName">
                <input type="text" class="form-control hextech-textarea" @bind="linkTagLine" placeholder="TagLine">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-warning" @onclick="ConfirmLinkUser">Valider</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editTipModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-hextech">
            <div class="modal-header">
                <h5 class="modal-title text-gold">Modifier le Conseil</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @if (editingTip != null)
                {
                <p class="text-gold small mb-2">Pour @editingTip.ChampionName par @editingTip.AuthorName</p>
                <textarea class="form-control hextech-textarea" rows="5" @bind="editingContent"></textarea>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-warning" @onclick="ConfirmEditTip">Sauvegarder</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="hextechConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-hextech shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-danger text-uppercase fw-bold">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> @confirmTitle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="fs-5 text-light mb-0">@confirmMessage</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger px-4 fw-bold" @onclick="ExecuteConfirmation">
                    Confirmer
                </button>
            </div>
        </div>
    </div>
</div>

@code {
private bool isSyncing = false;
private bool isPurging = false;

private List<LogEntry> logs = new();
private List<AppUserDto>? users;
private List<AdminTipDto>? tips;

// Variables Modale User
private AppUserDto? targetUser;
private string linkGameName = "";
private string linkTagLine = "";

// Variables Modale Tip
private AdminTipDto? editingTip;
private string editingContent = "";

// üî¥ Variables Modale Confirmation
private string confirmTitle = "";
private string confirmMessage = "";
private Func<Task>? onConfirmAction;

protected override async Task OnInitializedAsync() => await LoadAllData();

protected override async Task OnAfterRenderAsync(bool firstRender)
{
if (firstRender)
{
try {
await JS.InvokeVoidAsync("eval", "var collapseElementList = [].slice.call(document.querySelectorAll('.collapse')); var collapseList = collapseElementList.map(function (collapseEl) { return new bootstrap.Collapse(collapseEl, { toggle: false }) })");
} catch { }
}
}

private async Task LoadAllData()
{
try
{
users = await LoLClient.AdminGetAllUsersAsync();
tips = await LoLClient.AdminGetAllTipsAsync();
}
catch (Exception ex) { AddLog($"Erreur chargement : {ex.Message}"); }
}

// --- ACTIONS SYST√àME ---
private async Task SyncChampions() { /* ...code existant... */ isSyncing=true; try{var m=await LoLClient.AdminSyncChampionsAsync();AddLog(m);}catch(Exception e){AddLog(e.Message);} isSyncing=false; }
private async Task ResetDb() { /* ...code existant... */ isPurging=true; try{var m=await LoLClient.AdminResetChampionsAsync();AddLog(m);}catch(Exception e){AddLog(e.Message);} isPurging=false; }

// --- GESTION MODALE CONFIRMATION (NOUVEAU) ---
private void RequestUnlinkUser(AppUserDto user)
{
confirmTitle = "D√©lier le compte ?";
confirmMessage = $"Voulez-vous vraiment retirer le compte Riot de {user.Username} ?";
onConfirmAction = async () =>
{
AddLog($"D√©-liaison {user.Username}...");
if (await LoLClient.AdminUnlinkUserAsync(user.Id)) { AddLog("Fait."); await LoadAllData(); }
else { AddLog("Erreur lors de la d√©-liaison."); }
};
JS.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('hextechConfirmModal')).show()");
}

private void RequestDeleteTip(AdminTipDto tip)
{
confirmTitle = "Supprimer le conseil ?";
confirmMessage = "Cette action est irr√©versible. √ätes-vous s√ªr de vouloir supprimer ce tip ?";
onConfirmAction = async () =>
{
AddLog($"Suppression tip #{tip.Id}...");
if (await LoLClient.AdminDeleteTipAsync(tip.Id)) { AddLog("Tip supprim√©."); await LoadAllData(); }
else { AddLog("Erreur suppression tip."); }
};
JS.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('hextechConfirmModal')).show()");
}

private async Task ExecuteConfirmation()
{
if (onConfirmAction != null) await onConfirmAction.Invoke();
await JS.InvokeVoidAsync("eval", "bootstrap.Modal.getInstance(document.getElementById('hextechConfirmModal')).hide()");
}

// --- MODALES EXISTANTES (Link / Edit) ---
private void OpenLinkModal(AppUserDto user)
{
targetUser = user; linkGameName = ""; linkTagLine = "";
JS.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('linkUserModal')).show()");
}

private async Task ConfirmLinkUser()
{
if (targetUser == null) return;
AddLog($"Liaison {targetUser.Username}...");
if (await LoLClient.AdminLinkUserAsync(targetUser.Id, linkGameName, linkTagLine)) {
AddLog("R√©ussi."); await LoadAllData();
await JS.InvokeVoidAsync("eval", "bootstrap.Modal.getInstance(document.getElementById('linkUserModal')).hide()");
} else { AddLog("√âchec liaison."); }
}

private void OpenEditTipModal(AdminTipDto tip)
{
editingTip = tip; editingContent = tip.Content;
JS.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('editTipModal')).show()");
}

private async Task ConfirmEditTip()
{
if (editingTip == null) return;
if (await LoLClient.AdminUpdateTipAsync(editingTip.Id, editingContent)) {
AddLog("Tip modifi√©."); await LoadAllData();
await JS.InvokeVoidAsync("eval", "bootstrap.Modal.getInstance(document.getElementById('editTipModal')).hide()");
} else { AddLog("Erreur modif."); }
}

private void AddLog(string message) => logs.Add(new LogEntry(DateTime.Now.ToLongTimeString(), message));
record LogEntry(string Time, string Message);
}